#@ load("/values.star", "values")
#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:data", "data")
#@ load("@ytt:yaml", "yaml")
#@ load("@ytt:sha256", "sha256")

#@overlay/match by=overlay.subset({"kind": "Deployment", "metadata": {"name": "csi-azuredisk-controller"}})
---
metadata:
  #@overlay/match missing_ok=True
  annotations:
    kapp.k14s.io/disable-default-label-scoping-rules: ""
    kapp.k14s.io/update-strategy: fallback-on-replace
    azure-csi/data-values-hash: #@ sha256.sum(yaml.encode(values))
  namespace: #@ values.azureCSI.namespace

spec:
  #@overlay/match
  replicas: #@ values.azureCSI.deployment_replicas
  template:
    spec:
      containers:
        #@overlay/match by=overlay.subset({"name": "csi-attacher"})
        - args:
            #@overlay/match by=lambda index, left, right: "-timeout=" in left, expects=1
            - #@ "-timeout=" + values.azureCSI.attachTimeout
              #@ if values.azureCSI.http_proxy != "" :
            #@overlay/match by=overlay.subset({"name": "azuredisk"})
        - env:
            #@overlay/append
            - name: "HTTP_PROXY"
              value: #@ values.azureCSI.http_proxy
            - name: "HTTPS_PROXY"
              value: #@ values.azureCSI.https_proxy
            - name: "NO_PROXY"
              value: #@ values.azureCSI.no_proxy
        #@ end
        #@overlay/match by=overlay.subset({"name": "csi-provisioner"})
        - args:
            #@overlay/match by=lambda index, left, right: "--timeout=" in left, expects=1
            - #@ "--timeout=" + values.azureCSI.provisionTimeout
          #@ if values.azureCSI.region or values.azureCSI.zone:
            #@overlay/match by=overlay.index(-1), missing_ok=True
            - "--feature-gates=Topology=true"
            #@overlay/match by=overlay.index(-1), missing_ok=True
            - "--strict-topology=true"
          #@ end

