name: Provider Template Tests
# note: this name is referenced in recv_providers.yaml

on:
  # only on pull requests as some tests involves comparing results based on differences
  # between source and target branches
  pull_request:
    branches: [ main, release-*, package-based-lcm ]
    paths:
    - 'pkg/v1/tkg/**'
    - 'pkg/v1/providers/**'
    - '.github/workflows/providers.yaml'

jobs:
  build:
    name: Providers Templates Tests
    runs-on: ubuntu-latest
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v1

    - name: Fake dump some files
      shell: bash
      run: |
        echo "test" > clustergen_1.diff.txt
        echo "test" > clustergen.diff.txt
        echo "test" > clustergen.diff.html
        echo "test" > foo.diff.txt
        mkdir testdir
        echo "test" > testdir/clustergen2.diff.txt
        echo "test" > testdir/clustergen3.diff.txt
      id: read_artifact

    - id: upload-clustergen-results
      if: ${{ steps.clustergen.outputs.diffstatus == 0 }}
      uses: google-github-actions/upload-cloud-storage@main
      with:
        path: .
        destination: tkg-clustergen/test/upload
        credentials: ${{ secrets.GCP_BUCKET_SA }}
        glob: clustergen*.diff.txt

