#@ load("/values.star", "values")
#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:struct", "struct")

#@overlay/match by=overlay.subset({"kind": "DaemonSet", "metadata": {"name": "vsphere-cloud-controller-manager"}})
---
spec:
  template:
    spec:
      containers:
      #@overlay/match by=overlay.subset({"name": "vsphere-cloud-controller-manager"})
      - image: #@ "{}/{}:{}".format(values.vsphereCPI.image.repository, values.vsphereCPI.image.path, values.vsphereCPI.image.tag)
        #@overlay/match missing_ok=True
        imagePullPolicy: #@ values.vsphereCPI.image.pullPolicy
        args:
          #@overlay/append
          #@ if values.vsphereCPI.nsxt.enabled:
          - --configure-cloud-routes=true
          #@ end
          #@overlay/append
          #@yaml/text-templated-strings
          #@ for arg in struct.decode(values.vsphereCPI.cloudProviderExtraArgs):
          - --(@=arg @)=(@=struct.decode(values.vsphereCPI.cloudProviderExtraArgs)[arg]@)
          #@ end
      #@ if values.vsphereCPI.nsxt.enabled and values.vsphereCPI.nsxt.rootCAData != "" and values.vsphereCPI.nsxt.clientCertData != "" and values.vsphereCPI.nsxt.clientCertKeyData != "" :
      #@overlay/match by=overlay.subset({"name": "vsphere-cloud-controller-manager"})
      - volumeMounts:  
        #@overlay/append
        - mountPath: /etc/cloud/nsxt
          name: nsxt-certificates-volume
          readOnly: true
      volumes:  
      #@overlay/match by=overlay.subset({"name": "vsphere-cloud-controller-manager"})
        #@overlay/append
        - secret:
            secretName: nsxt-tls-certificates
          name: nsxt-certificates-volume
      #@ end
