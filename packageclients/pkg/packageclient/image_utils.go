// Copyright 2021 VMware, Inc. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

package packageclient

import (
	"fmt"
	"strings"

	"github.com/google/go-containerregistry/pkg/name"
	"github.com/pkg/errors"

	kappipkg "github.com/vmware-tanzu/carvel-kapp-controller/pkg/apis/packaging/v1alpha1"
	"github.com/vmware-tanzu/tanzu-framework/packageclients/pkg/packagedatamodel"
)

// ParseRegistryImageURL parses the registry image URL to get repository and tag, tag is empty if not specified
func ParseRegistryImageURL(imgURL string) (repository, tag string, err error) {
	ref, err := name.ParseReference(imgURL, name.WeakValidation)
	if err != nil {
		return "", "", err
	}

	repository = ref.Context().String()
	tag = ref.Identifier()
	// the parser function sets the tag to "latest" if not specified, however we want it to be empty
	if tag == packagedatamodel.DefaultRepositoryImageTag && !strings.HasSuffix(imgURL, ":"+packagedatamodel.DefaultRepositoryImageTag) {
		tag = ""
	}
	return repository, tag, nil
}

// GetCurrentRepositoryAndTagInUse fetches the current tag used by package repository, taking tagselection into account
func GetCurrentRepositoryAndTagInUse(pkgr *kappipkg.PackageRepository) (repository, tag string, err error) {
	if pkgr.Spec.Fetch == nil || pkgr.Spec.Fetch.ImgpkgBundle == nil {
		return "", "", errors.New("failed to find OCI registry URL")
	}

	repository, tag, err = ParseRegistryImageURL(pkgr.Spec.Fetch.ImgpkgBundle.Image)
	if err != nil {
		return "", "", errors.Wrap(err, "failed to parse OCI registry URL")
	}

	if tag == "" {
		tag = packagedatamodel.DefaultRepositoryImageTag
	}

	if pkgr.Spec.Fetch.ImgpkgBundle.TagSelection != nil && pkgr.Spec.Fetch.ImgpkgBundle.TagSelection.Semver != nil {
		tag = fmt.Sprintf("(%s)", pkgr.Spec.Fetch.ImgpkgBundle.TagSelection.Semver.Constraints)
	}

	return repository, tag, nil
}
